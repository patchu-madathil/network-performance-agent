<!DOCTYPE html>
<html>
<head>
    <title>Internet Measurement App</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        .test-section { border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin-bottom: 20px; }
        .test-section h2 { margin-top: 0; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:disabled { background-color: #ccc; }
        .results-grid { display: grid; grid-template-columns: 150px 1fr; gap: 5px; }
        .results-grid span { font-weight: bold; }
        #voip-status { font-style: italic; color: #555; }
        
        /* --- NEW ERROR STYLE --- */
        #library-errors {
            color: #721c24; /* Dark red text */
            background-color: #f8d7da; /* Light red background */
            border: 1px solid #f5c6cb; /* Red border */
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>

    <h1>Comprehensive Internet Measurement App</h1>

    <div id="library-errors"></div>

    <div class="test-section">
        <h2>1. Speed Test (M-Lab)</h2>
        <button id="start-speed-test">Start Speed Test</button>
        <div class="results-grid" style="margin-top: 15px;">
            <span>Download:</span> <span id="dl-speed">...</span>
            <span>Upload:</span> <span id="ul-speed">...</span>
            <span>Latency:</span> <span id="latency">...</span>
        </div>
    </div>

    <div class="test-section">
        <h2>2. VoIP Simulation (Janus Echo Test)</h2>
        <p>This test makes a real audio call to a public echo server to measure network quality and calculate a MOS score.</p>
        <button id="start-voip-test">Start VoIP Test (15s)</button>
        <div id="voip-status" style="margin-top: 15px;">Status: Idle</div>
        <div class="results-grid" style="margin-top: 10px;">
            <span>MOS Score (1-5):</span> <span id="voip-mos">...</span>
            <span>Latency (RTT):</span> <span id="voip-rtt">...</span>
            <span>Jitter:</span> <span id="voip-jitter">...</span>
            <span>Packet Loss:</span> <span id="voip-loss">...</span>
        </div>
    </div>

    <div class="test-section">
        <h2>3. Video Performance Tests</h2>

        <h3>YouTube Test</h3>
        <p>This test measures the startup time and buffering events for an embedded 4K YouTube video. Quality is <strong>suggested</strong> but not guaranteed by YouTube.</p>
        <button id="start-youtube-test" disabled>Start YouTube Test (20s)</button>
        <div id="youtube-player" style="margin-top: 10px;"></div>
        <div class="results-grid" style="margin-top: 10px;">
            <span>Time to Start:</span> <span id="youtube-tts">...</span>
            <span>Rebuffer Events:</span> <span id="youtube-rebuffers">...</span>
        </div>

        <hr style="margin: 20px 0;">

        <h3>HTML5 Video Test (Recommended)</h3>
        <p>This test uses a public video file for more accurate metrics, including dropped frames.</p>
        <button id="start-html5-test">Start HTML5 Test</button>
        
        <video id="html5-video-player" width="100%" controls muted
            src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4" 
            style="display:none; margin-top: 10px; background-color: black;">
        </video>
        
        <div class="results-grid" style="margin-top: 10px;">
            <span>Time to Start:</span> <span id="html5-tts">...</span>
            <span>Rebuffer Events:</span> <span id="html5-rebuffers">...</span>
            <span>Dropped Frames:</span> <span id="html5-dropped">...</span>
        </div>
    </div>


    <script src="https://ndt-js.s3.amazonaws.com/ndt7/v0.9.0/ndt7.js"></script>
    
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/janus-gateway/1.1.5/janus.js"></script>

    <script>
        var youtubeTag = document.createElement('script');
        youtubeTag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(youtubeTag, firstScriptTag);
    </script>
    
    <script>
        
        // ===================================
        // --- 1. SPEED TEST LOGIC ---
        // ===================================
        document.getElementById('start-speed-test').addEventListener('click', runSpeedTest);

        async function runSpeedTest() {
            this.disabled = true;
            const dlSpan = document.getElementById('dl-speed');
            const ulSpan = document.getElementById('ul-speed');
            const latSpan = document.getElementById('latency');

            dlSpan.textContent = "Connecting...";
            ulSpan.textContent = "..."; 
            latSpan.textContent = "...";
            
            const client = new ndt7.Client();
            
            let uploadTestStarted = false; 
            
            client.onmeasurement = (measurement) => {
                if (measurement.kind === 'download') {
                    if (measurement.throughput?.Value) {
                        dlSpan.textContent = `${(measurement.throughput.Value / 1000).toFixed(2)} Mbps`;
                    } else {
                        dlSpan.textContent = "Running Download...";
                    }
                }
                
                if (measurement.kind === 'upload') {
                    if (!uploadTestStarted) {
                        ulSpan.textContent = "Running Upload...";
                        uploadTestStarted = true;
                    }
                    if (measurement.throughput?.Value) {
                        ulSpan.textContent = `${(measurement.throughput.Value / 1000).toFixed(2)} Mbps`;
                    }
                }
                
                if (measurement.kind === 'latency') {
                     if (measurement.rtt?.Value) {
                        latSpan.textContent = `${measurement.rtt.Value.toFixed(0)} ms`;
                     } else {
                        latSpan.textContent = "Testing Latency...";
                     }
                }
            };

            try {
                await client.start();
                
                const summary = await client.getSummary();
                dlSpan.textContent = `${(summary.download.throughput.Value / 1000).toFixed(2)} Mbps (Final)`;
                ulSpan.textContent = `${(summary.upload.throughput.Value / 1000).toFixed(2)} Mbps (Final)`;
                latSpan.textContent = `${summary.latency.Value.toFixed(0)} ms (Final)`;

            } catch (err) {
                console.error("Speed test failed:", err.message);
                dlSpan.textContent = "error";
                ulSpan.textContent = "error";
                latSpan.textContent = "error";
            } finally {
                // Re-enable button only if the library didn't fail to load
                if (typeof ndt7 !== 'undefined') {
                    document.getElementById('start-speed-test').disabled = false;
                }
            }
        }

        // ===================================
        // --- 2. WEBRTC VOIP TEST LOGIC ---
        // ===================================
        
        const voipButton = document.getElementById('start-voip-test');
        const voipStatus = document.getElementById('voip-status');
        const mosSpan = document.getElementById('voip-mos');
        const rttSpan = document.getElementById('voip-rtt');
        const jitterSpan = document.getElementById('voip-jitter');
        const lossSpan = document.getElementById('voip-loss');
        
        let janus = null;
        let echotest = null;
        let voipStatsInterval = null;

        // Initialize Janus library
        // This will only run if Janus was loaded (see check below)
        if (typeof Janus !== 'undefined') {
            Janus.init({
                debug: false,
                callback: () => voipButton.disabled = false
            });
        }
        voipButton.addEventListener('click', runVoipTest);
        
        function runVoipTest() {
            voipButton.disabled = true;
            voipStatus.textContent = "Status: Initializing...";
            
            janus = new Janus({
                server: "https://janus.conf.meetecho.com/janus",
                success: () => {
                    voipStatus.textContent = "Status: Attaching to EchoTest plugin...";
                    janus.attach({
                        plugin: "janus.plugin.echotest",
                        success: (pluginHandle) => {
                            echotest = pluginHandle;
                            voipStatus.textContent = "Status: Starting call (check for mic permission)...";
                            echotest.createOffer({
                                media: { audio: true, video: false },
                                success: (jsep) => {
                                    voipStatus.textContent = "Status: Connecting...";
                                    echotest.send({ message: { audio: true }, jsep: jsep });
                                },
                                error: (err) => {
                                    console.error("WebRTC Offer Error:", err);
                                    voipStatus.textContent = "Error: " + err;
                                    voipButton.disabled = false;
                                }
                            });
                        },
                        error: (err) => {
                            console.error("Janus attach error:", err);
                            voipStatus.textContent = "Error: Could not attach to plugin.";
                            voipButton.disabled = false;
                        },
                        onmessage: (msg, jsep) => {
                            if (jsep) {
                                echotest.handleRemoteJsep({ jsep: jsep });
                            }
                        },
                        webrtcState: (isConnected) => {
                            if (isConnected) {
                                voipStatus.textContent = "Status: Call established. Measuring for 15s...";
                                startVoipStatsPolling();
                            } else {
                                voipStatus.textContent = "Status: Call disconnected.";
                            }
                        },
                        oncleanup: () => {
                            voipStatus.textContent = "Status: Test finished.";
                            clearInterval(voipStatsInterval);
                            voipButton.disabled = false;
                        }
                    });
                },
                error: (err) => {
                    console.error("Janus init error:", err);
                    voipStatus.textContent = "Error: Could not connect to Janus server.";
                    voipButton.disabled = false;
                }
            });
            
            setTimeout(stopVoipTest, 15000);
        }

        function stopVoipTest() {
            if (janus) {
                janus.destroy();
                janus = null;
            }
        }
        
        function startVoipStatsPolling() {
            let lastPacketsLost = 0;
            let lastPacketsRecv = 0;

            voipStatsInterval = setInterval(async () => {
                const pc = echotest.getPeerConnection();
                if (!pc) return;

                const stats = await pc.getStats();
                let rtt = 0;
                let jitter = 0;
                let packetsLost = 0;
                let packetsReceived = 0;

                stats.forEach(report => {
                    if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                        rtt = report.currentRoundTripTime * 1000; // in ms
                    }
                    if (report.type === 'inbound-rtp' && report.kind === 'audio') {
                        jitter = report.jitter * 1000; // in ms
                        packetsLost = report.packetsLost;
                        packetsReceived = report.packetsReceived;
                    }
                });
                
                const totalPackets = (packetsReceived - lastPacketsRecv) + (packetsLost - lastPacketsLost);
                const lossPercent = (totalPackets === 0) ? 0 : ((packetsLost - lastPacketsLost) / totalPackets) * 100;

                lastPacketsLost = packetsLost;
                lastPacketsRecv = packetsReceived;

                const mos = calculateMOS(rtt, jitter, lossPercent);

                mosSpan.textContent = mos.toFixed(2);
                rttSpan.textContent = `${rtt.toFixed(0)} ms`;
                jitterSpan.textContent = `${jitter.toFixed(0)} ms`;
                lossSpan.textContent = `${lossPercent.toFixed(2)} %`;
                
            }, 1000);
        }

        function calculateMOS(rtt, jitter, packetLossPercent) {
            const effectiveLatency = rtt + (jitter * 2) + 10;
            let rValue;
            if (effectiveLatency < 160) {
                rValue = 93.2 - (effectiveLatency / 40);
            } else {
                rValue = 93.2 - (effectiveLatency - 120) / 10;
            }
            rValue = rValue - (packetLossPercent * 2.5);
            let mos = 1 + (0.035 * rValue) + (0.000007 * rValue * (rValue - 60) * (100 * rValue));
            if (mos < 1) return 1;
            if (mos > 4.5) return 4.5;
            return mos;
        }

        // ===================================
        // --- 3. VIDEO TEST LOGIC ---
        // ===================================
        
        var ytPlayer;
        var ytStartTime, ytVideoStartTime;
        var ytRebufferCount = 0;
        var ytHasStarted = false;

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtube-player', {
                height: '240',
                width: '426',
                videoId: 'LXb3EKWsInQ',
                playerVars: { 'controls': 0, 'autoplay': 0 },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            document.getElementById('start-youtube-test').disabled = false;
        }

        document.getElementById('start-youtube-test').addEventListener('click', () => {
            document.getElementById('start-youtube-test').disabled = true;
            ytStartTime = performance.now();
            ytHasStarted = false;
            ytRebufferCount = 0;
            
            document.getElementById('youtube-rebuffers').textContent = '0';
            document.getElementById('youtube-tts').textContent = 'running...';
            
            ytPlayer.setPlaybackQuality('hd1080');
            ytPlayer.playVideo();

            setTimeout(() => {
                ytPlayer.stopVideo();
                document.getElementById('start-youtube-test').disabled = false;
            }, 20000);
        });

        function onPlayerStateChange(event) {
            const state = event.data;
            if (state === YT.PlayerState.PLAYING && !ytHasStarted) {
                ytVideoStartTime = performance.now();
                document.getElementById('youtube-tts').textContent = `${(ytVideoStartTime - ytStartTime).toFixed(0)} ms`;
                ytHasStarted = true;
            }
            if (state === YT.PlayerState.BUFFERING && ytHasStarted) {
                ytRebufferCount++;
                document.getElementById('youtube-rebuffers').textContent = ytRebufferCount;
            }
        }

        const videoPlayer = document.getElementById('html5-video-player');
        let html5StartTime, html5VideoStartTime;
        let html5RebufferCount = 0;
        let html5HasStarted = false;
        let initialDroppedFrames = 0;

        document.getElementById('start-html5-test').addEventListener('click', () => {
            videoPlayer.style.display = 'block';
            videoPlayer.load();
            
            html5StartTime = performance.now();
            html5HasStarted = false;
            html5RebufferCount = 0;
            
            document.getElementById('html5-tts').textContent = 'running...';
            document.getElementById('html5-rebuffers').textContent = '0';
            document.getElementById('html5-dropped').textContent = '0';

            videoPlayer.play().catch(err => {
                console.error("HTML5 Playback Error:", err);
                document.getElementById('html5-tts').textContent = "Error";
            });
        });

        videoPlayer.addEventListener('playing', () => {
            if (!html5HasStarted) {
                html5VideoStartTime = performance.now();
                document.getElementById('html5-tts').textContent = `${(html5VideoStartTime - html5StartTime).toFixed(0)} ms`;
                html5HasStarted = true;
                const quality = videoPlayer.getVideoPlaybackQuality();
                initialDroppedFrames = quality.droppedVideoFrames;
            }
        });

        videoPlayer.addEventListener('waiting', () => {
            if (html5HasStarted) {
                html5RebufferCount++;
                document.getElementById('html5-rebuffers').textContent = html5RebufferCount;
            }
        });
        
        videoPlayer.addEventListener('timeupdate', () => {
            if (html5HasStarted && videoPlayer.getVideoPlaybackQuality) {
                const quality = videoPlayer.getVideoPlaybackQuality();
                const dropped = quality.droppedVideoFrames - initialDroppedFrames;
                document.getElementById('html5-dropped').textContent = dropped;
            }
        });

        videoPlayer.addEventListener('ended', () => {
            if (videoPlayer.getVideoPlaybackQuality) {
                const quality = videoPlayer.getVideoPlaybackQuality();
                const dropped = quality.droppedVideoFrames - initialDroppedFrames;
                document.getElementById('html5-dropped').textContent = dropped;
            }
        });


        // --- NEW: LIBRARY LOADING CHECK ---
        document.addEventListener('DOMContentLoaded', () => {
            const errorDiv = document.getElementById('library-errors');
            let errorMessages = [];

            // Check for M-Lab (ndt7)
            if (typeof ndt7 === 'undefined') {
                errorMessages.push("<strong>Speed Test Error:</strong> The M-Lab library (ndt7.js) failed to load. This test is disabled.");
                const btn = document.getElementById('start-speed-test');
                btn.disabled = true;
                btn.textContent = "Speed Test (Error)";
            }

            // Check for WebRTC (Janus)
            if (typeof Janus === 'undefined') {
                errorMessages.push("<strong>VoIP Test Error:</strong> The Janus WebRTC library (janus.js) failed to load. This test is disabled.");
                const btn = document.getElementById('start-voip-test');
                btn.disabled = true;
                btn.textContent = "VoIP Test (Error)";
            }
            
            // Note: The YouTube test is already handled. Its button is 'disabled' by default
            // and is only enabled by the 'onPlayerReady' callback, which only fires if the
            // YouTube API loads successfully. No extra check is needed.

            // Display errors if any
            if (errorMessages.length > 0) {
                errorDiv.innerHTML = errorMessages.join("<br><br>");
                errorDiv.style.display = 'block';
            }
        });

    </script>
</body>
</html>