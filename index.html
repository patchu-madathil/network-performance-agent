<script src="https://unpkg.com/@m-lab/ndt7-js@0.9.0/dist/ndt7.js"></script>
    
    <script src="https://unpkg.com/webrtc-adapter@9.0.3/out/adapter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/janus-gateway/1.1.5/janus.js"></script>

    <script>
        var youtubeTag = document.createElement('script');
        youtubeTag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(youtubeTag, firstScriptTag);
    </script>
    
    <script>
        
        // ===================================
        // --- 1. SPEED TEST LOGIC ---
        // ===================================
        document.getElementById('start-speed-test').addEventListener('click', runSpeedTest);

        async function runSpeedTest() {
            this.disabled = true;
            const dlSpan = document.getElementById('dl-speed');
            const ulSpan = document.getElementById('ul-speed');
            const latSpan = document.getElementById('latency');

            dlSpan.textContent = "Connecting...";
            ulSpan.textContent = "..."; 
            latSpan.textContent = "...";
            
            const client = new ndt7.Client();
            
            let uploadTestStarted = false; 
            
            client.onmeasurement = (measurement) => {
                if (measurement.kind === 'download') {
                    if (measurement.throughput?.Value) {
                        dlSpan.textContent = `${(measurement.throughput.Value / 1000).toFixed(2)} Mbps`;
                    } else {
                        dlSpan.textContent = "Running Download...";
                    }
                }
                
                if (measurement.kind === 'upload') {
                    if (!uploadTestStarted) {
                        ulSpan.textContent = "Running Upload...";
                        uploadTestStarted = true;
                    }
                    if (measurement.throughput?.Value) {
                        ulSpan.textContent = `${(measurement.throughput.Value / 1000).toFixed(2)} Mbps`;
                    }
                }
                
                if (measurement.kind === 'latency') {
                     if (measurement.rtt?.Value) {
                        latSpan.textContent = `${measurement.rtt.Value.toFixed(0)} ms`;
                     } else {
                        latSpan.textContent = "Testing Latency...";
                     }
                }
            };

            try {
                await client.start();
                
                const summary = await client.getSummary();
                dlSpan.textContent = `${(summary.download.throughput.Value / 1000).toFixed(2)} Mbps (Final)`;
                ulSpan.textContent = `${(summary.upload.throughput.Value / 1000).toFixed(2)} Mbps (Final)`;
                latSpan.textContent = `${summary.latency.Value.toFixed(0)} ms (Final)`;

            } catch (err) {
                console.error("Speed test failed:", err.message);
                dlSpan.textContent = "error";
                ulSpan.textContent = "error";
                latSpan.textContent = "error";
            } finally {
                // Re-enable button only if the library didn't fail to load
                if (typeof ndt7 !== 'undefined') {
                    document.getElementById('start-speed-test').disabled = false;
                }
            }
        }

        // ===================================
        // --- 2. WEBRTC VOIP TEST LOGIC ---
        // ===================================
        
        const voipButton = document.getElementById('start-voip-test');
        const voipStatus = document.getElementById('voip-status');
        const mosSpan = document.getElementById('voip-mos');
        const rttSpan = document.getElementById('voip-rtt');
        const jitterSpan = document.getElementById('voip-jitter');
        const lossSpan = document.getElementById('voip-loss');
        
        let janus = null;
        let echotest = null;
        let voipStatsInterval = null;

        // Initialize Janus library
        // This will only run if Janus was loaded (see check below)
        if (typeof Janus !== 'undefined') {
            Janus.init({
                debug: false,
                callback: () => voipButton.disabled = false
            });
        }
        voipButton.addEventListener('click', runVoipTest);
        
        function runVoipTest() {
            voipButton.disabled = true;
            voipStatus.textContent = "Status: Initializing...";
            
            janus = new Janus({
                server: "https://janus.conf.meetecho.com/janus",
                success: () => {
                    voipStatus.textContent = "Status: Attaching to EchoTest plugin...";
                    janus.attach({
                        plugin: "janus.plugin.echotest",
                        success: (pluginHandle) => {
                            echotest = pluginHandle;
                            voipStatus.textContent = "Status: Starting call (check for mic permission)...";
                            echotest.createOffer({
                                media: { audio: true, video: false },
                                success: (jsep) => {
                                    voipStatus.textContent = "Status: Connecting...";
                                    echotest.send({ message: { audio: true }, jsep: jsep });
                                },
                                error: (err) => {
                                    console.error("WebRTC Offer Error:", err);
                                    voipStatus.textContent = "Error: " + err;
                                    voipButton.disabled = false;
                                }
                            });
                        },
                        error: (err) => {
                            console.error("Janus attach error:", err);
                            voipStatus.textContent = "Error: Could not attach to plugin.";
                            voipButton.disabled = false;
                        },
                        onmessage: (msg, jsep) => {
                            if (jsep) {
                                echotest.handleRemoteJsep({ jsep: jjsep });
                            }
                        },
                        webrtcState: (isConnected) => {
                            if (isConnected) {
                                voipStatus.textContent = "Status: Call established. Measuring for 15s...";
                                startVoipStatsPolling();
                            } else {
                                voipStatus.textContent = "Status: Call disconnected.";
                            }
                        },
                        oncleanup: () => {
                            voipStatus.textContent = "Status: Test finished.";
                            clearInterval(voipStatsInterval);
                            voipButton.disabled = false;
                        }
                    });
                },
                error: (err) => {
                    console.error("Janus init error:", err);
                    voipStatus.textContent = "Error: Could not connect to Janus server.";
                    voipButton.disabled = false;
                }
            });
            
            setTimeout(stopVoipTest, 15000);
        }

        function stopVoipTest() {
            if (janus) {
                janus.destroy();
                janus = null;
            }
        }
        
        function startVoipStatsPolling() {
            let lastPacketsLost = 0;
            let lastPacketsRecv = 0;

            voipStatsInterval = setInterval(async () => {
                const pc = echotest.getPeerConnection();
                if (!pc) return;

                const stats = await pc.getStats();
                let rtt = 0;
                let jitter = 0;
                let packetsLost = 0;
                let packetsReceived = 0;

                stats.forEach(report => {
                    if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                        rtt = report.currentRoundTripTime * 1000; // in ms
                    }
                    if (report.type === 'inbound-rtp' && report.kind === 'audio') {
                        jitter = report.jitter * 1000; // in ms
                        packetsLost = report.packetsLost;
                        packetsReceived = report.packetsReceived;
                    }
                });
                
                const totalPackets = (packetsReceived - lastPacketsRecv) + (packetsLost - lastPacketsLost);
                const lossPercent = (totalPackets === 0) ? 0 : ((packetsLost - lastPacketsLost) / totalPackets) * 100;

                lastPacketsLost = packetsLost;
                lastPacketsRecv = packetsReceived;

                const mos = calculateMOS(rtt, jitter, lossPercent);

                mosSpan.textContent = mos.toFixed(2);
                rttSpan.textContent = `${rtt.toFixed(0)} ms`;
                jitterSpan.textContent = `${jitter.toFixed(0)} ms`;
                lossSpan.textContent = `${lossPercent.toFixed(2)} %`;
                
            }, 1000);
        }

        function calculateMOS(rtt, jitter, packetLossPercent) {
            const effectiveLatency = rtt + (jitter * 2) + 10;
            let rValue;
            if (effectiveLatency < 160) {
                rValue = 93.2 - (effectiveLatency / 40);
            } else {
                rValue = 93.2 - (effectiveLatency - 120) / 10;
            }
            rValue = rValue - (packetLossPercent * 2.5);
            let mos = 1 + (0.035 * rValue) + (0.000007 * rValue * (rValue - 60) * (100 - rValue));
            if (mos < 1) return 1;
            if (mos > 4.5) return 4.5;
            return mos;
        }

        // ===================================
        // --- 3. VIDEO TEST LOGIC ---
        // ===================================
        
        // ... (rest of video test code) ...


        // --- LIBRARY LOADING CHECK ---
        document.addEventListener('DOMContentLoaded', () => {
            const errorDiv = document.getElementById('library-errors');
            let errorMessages = [];

            // Check for M-Lab (ndt7)
            if (typeof ndt7 === 'undefined') {
                errorMessages.push("<strong>Speed Test Error:</strong> The M-Lab library (ndt7.js) failed to load. This test is disabled.");
                const btn = document.getElementById('start-speed-test');
                btn.disabled = true;
                btn.textContent = "Speed Test (Error)";
            }

            // Check for WebRTC (Janus)
            if (typeof Janus === 'undefined') {
                errorMessages.push("<strong>VoIP Test Error:</strong> The Janus WebRTC library (janus.js) failed to load. This test is disabled.");
                const btn = document.getElementById('start-voip-test');
                btn.disabled = true;
                btn.textContent = "VoIP Test (Error)";
            }
            
            // Display errors if any
            if (errorMessages.length > 0) {
                errorDiv.innerHTML = errorMessages.join("<br><br>");
                errorDiv.style.display = 'block';
            }
        });

    </script>
</body>
</html>